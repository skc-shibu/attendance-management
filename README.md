# 勤怠管理サイト

Google Apps Script と Google スプレッドシートだけで動くシンプルな勤怠打刻ツールです。出勤/休憩/退勤をワンクリックで保存し、チャット貼り付け用の定型文を自動生成します。祝日カレンダー連携による営業日計算と、月次サマリ表示にも対応します。

## 主な機能
- 出勤/休憩開始/休憩終了/退勤のワンクリック打刻
- 打刻結果からコピー用テンプレートを自動生成（出勤/退勤メッセージ）
- 月別シートに日次データを保存し、営業日ベースのサマリを表示
- 公式「日本の祝日」カレンダー連携（取得不可時は警告を表示して継続）
- ユーザーごとの設定保存（作業場所・案件名・休憩時刻・休憩補完・残業マイナス抑止）

## ファイル構成
- `Code.gs` : GAS サーバーサイド。打刻 API・月次取得・祝日キャッシュ・設定保存などすべてのロジックを実装。
- `Index.html` : 単一ページの土台。ルーター、共通スタイル、フロントのロジックを保持。
- `Clock.html` : 打刻ビュー（今日のステータス表示、ボタン群、コピー用テキストエリア）。
- `History.html` : 月次履歴/サマリビュー（前月/次月遷移、営業日サマリ、テーブル表示）。
- `Settings.html` : 各種設定ビュー（作業場所/案件名/休憩設定/挙動オプション、祝日カレンダー有効化）。
- `仕様書.md` : 全体仕様の確定版ドキュメント。

## 事前準備
1. **スプレッドシート**  
   - 1シート=1か月方式。シート名は `YYYY-MM`。  
   - ヘッダー（1行目）は固定: `日付, 曜, 出勤時刻, 休憩開始時刻, 休憩終了時刻, 退勤時刻, 実働(時間), 作業内容, 作業場所, 備考`  
   - シートが無い月は初回アクセス時に自動生成され、月末までの空行が埋め込まれます。
2. **Apps Script プロジェクト**  
   - タイムゾーン: `Asia/Tokyo` に設定。  
   - `Code.gs` と各 HTML を同名ファイルとしてアップロード/貼り付け。
3. **Script Properties**  
   - `spreadsheetId`: 勤怠DBとなるスプレッドシートの ID（必須）。  
   - `holidayCalendarId`（任意）: 祝日カレンダーを差し替えたい場合に指定。
4. **権限**  
   - スプレッドシートへの編集権限と、Google カレンダー（祝日）参照権限が実行ユーザーに必要です。

## デプロイ手順（Web アプリ）
1. Apps Script 画面で「デプロイ」→「新しいデプロイ」。  
2. 種類: **ウェブアプリ** を選択。  
3. 実行するユーザー: **アクセスしているユーザー**（UserProperties やカレンダー参照をユーザー単位にするため）。  
4. アクセスできるユーザー: 自分 / ドメイン / 全員 など運用に合わせて選択。  
5. デプロイ後に発行された URL をブラウザで開けば動作します。

## 使い方
- `#/clock` 打刻ページ  
  - 今日の日付と現在のステータスを表示。各ボタンで即時打刻し、コピー用テキストを生成します。  
  - 通信中は全ボタンが自動で無効化され、冪等に更新されます。
- `#/history` 履歴ページ  
  - 前月/次月/今月移動、営業日ベースのサマリ4指標（所定/実働/所定-to-date/残業-to-date）、警告バナー、日次テーブルを表示。  
  - 祝日カレンダー未取得時は警告バッジを表示します。
- `#/settings` 設定ページ  
  - 作業場所・案件名・休憩開始時刻・休憩時間・退勤時の休憩自動補完・残業マイナス抑止を設定し、UserProperties に保存します。  
  - 「祝日カレンダー有効化」ボタンで公式カレンダーへの subscribe を試行します。

## データ仕様（サーバー側）
- **シート列**: 上記ヘッダー順。主キーは `日付(YYYY-MM-DD)`。既存行があれば上書きしないのがデフォルト。  
- **UserProperties**:  
  - `defaultWorkLocation` (`本社出社|テレワーク|常駐先|客先`)  
  - `projectName` (案件名)  
  - `defaultBreakStart` (`HH:mm`, デフォルト `13:00`)  
  - `defaultBreakMinutes` (数値, デフォルト `60`)  
  - `overtimeNonNegative` (bool, 残業を 0 未満にしない)  
  - `autoFillBreakOnClockOut` (bool, 退勤時に休憩を自動補完, デフォルト true)
- **ScriptProperties**: `spreadsheetId`（必須）、`holidayCalendarId`（任意）。
- **祝日判定**: 公式カレンダー ID `ja.japanese.official#holiday@group.v.calendar.google.com` を優先。月単位で取得し 6h キャッシュ。取得不可時は `status=unavailable` で継続し警告表示。

## 主要 API（google.script.run）
- `getSettings() / saveSettings(partial)` : 設定の取得/保存。  
- `getTodayStatus()` : 今日の行と入力状況（警告フラグ付き）。  
- `clockIn() / startBreak() / endBreak() / clockOut()` : 各打刻。退勤時は休憩自動補完と実働計算を実施。  
- `getMonthData(yyyyMM)` : 月次行データ一括取得。  
- `getMonthSummary(yyyyMM)` : 営業日ベースのサマリ値と警告数を返却。  
- `getHolidays(yyyyMM)` : 祝日セットと取得ステータス。  
- `ensureHolidayCalendar()` : 祝日カレンダーへの subscribe を試行。

## よくあるハマりどころ
- **spreadsheetId 未設定**: `ScriptProperties` に設定しないと `SPREADSHEET_NOT_CONFIGURED` エラーになります。  
- **祝日カレンダー null**: Google カレンダー権限や Workspace 制限で取得できない場合は `holidaySourceStatus=unavailable` となり、営業日計算は祝日除外なしで進みます。  
- **文字化けが見える場合**: 各 HTML / GAS は UTF-8 で保存してください（IDE の文字コード設定を確認）。

## ライセンス / 著作権
社内利用を想定したテンプレートです。必要に応じて貴社ポリシーに合わせてください。
